
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Summary - Remittance Nexus System</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/income_summary.css">
    <style>
        /* Basic styling for the page */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.5;
            color: #333;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        .card-header {
            padding: 16px 24px;
            border-bottom: 1px solid #eee;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .card-description {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }
        .card-content {
            padding: 16px 24px;
        }
        .card-footer {
            padding: 16px 24px;
            display: flex;
            align-items: center;
        }
        .button {
            display: inline-block;
            background-color: #1eaedb;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: 500;
            text-decoration: none;
        }
        .button:hover {
            background-color: #1a9ac5;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .select-container {
            position: relative;
        }
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 8px center;
        }
        .date-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            font-weight: 500;
            color: #666;
        }
        .text-right {
            text-align: right;
        }
        .summary-total {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 16px;
            background-color: #f0f7ff;
            border-radius: 8px;
        }
        .navbar {
            background-color: #1eaedb;
            padding: 10px 0;
            color: white;
        }
        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .navbar-logo {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .navbar-logo svg {
            margin-right: 8px;
        }
        .navbar-links {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-links li {
            margin-left: 20px;
        }
        .navbar-links a {
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                Audit
            </div>
            <ul class="navbar-links">
                <li><a href="index.php">Dashboard</a></li>
                <li><a href="transactions.php">Verified</a></li>
                <li><a href="income_summary.html">Revenue</a></li>
                <li><a href="#">Issues</a></li>
                <li><a href="logout.php">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>Income Summary</h1>
            <a href="index.php" class="button">Back to Dashboard</a>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Filter Options</h2>
                <p class="card-description">
                    Select an income line and date range to view the summary
                </p>
            </div>
            <div class="card-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="incomeLineSelect">Income Line</label>
                        <div class="select-container">
                            <select id="incomeLineSelect">
                                <option value="">Select Income Line</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" class="date-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate" class="date-input">
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button id="generateSummaryBtn" class="button">Generate Summary</button>
            </div>
        </div>
        
        <div id="summaryResults" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" id="summaryTitle">Summary for [Income Line]</h2>
                    <p class="card-description" id="summaryDateRange">
                        From [Start Date] to [End Date]
                    </p>
                </div>
                <div class="card-content">
                    <div class="summary-total" id="totalIncomeDisplay">
                        Total Income: â‚¦0.00
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Transaction Details</h2>
                    <p class="card-description" id="transactionCount">
                        Showing 0 transactions
                    </p>
                </div>
                <div class="card-content">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Receipt No.</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const incomeLineSelect = document.getElementById('incomeLineSelect');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const generateSummaryBtn = document.getElementById('generateSummaryBtn');
            const summaryResults = document.getElementById('summaryResults');
            const summaryTitle = document.getElementById('summaryTitle');
            const summaryDateRange = document.getElementById('summaryDateRange');
            const totalIncomeDisplay = document.getElementById('totalIncomeDisplay');
            const transactionCount = document.getElementById('transactionCount');
            const transactionsTable = document.getElementById('transactionsTable');
            
            // Set default dates to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0]; // YYYY-MM-DD
            startDateInput.value = formattedDate;
            endDateInput.value = formattedDate;
            
            // Fetch income line accounts
            fetchIncomeLineAccounts();
            
            // Event listener for generate summary button
            generateSummaryBtn.addEventListener('click', function() {
                generateIncomeSummary();
            });
            
            // Fetch income line accounts
            function fetchIncomeLineAccounts() {
                // Clear existing options
                incomeLineSelect.innerHTML = '<option value="">Select Income Line</option>';
                
                // Fetch accounts via AJAX
                fetch('api/accounts/income-lines.php')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Populate select with fetched accounts
                        data.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account.acct_code;
                            option.textContent = `${account.acct_desc} (${account.acct_code})`;
                            option.dataset.tableId = account.acct_table_name;
                            incomeLineSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching income line accounts:', error);
                        // Fallback with sample data if API fails
                        const sampleAccounts = [
                            { acct_id: "1", acct_code: "401", acct_desc: "Shop Rent", acct_table_name: "income_shop_rent" },
                            { acct_id: "2", acct_code: "402", acct_desc: "Service Charge", acct_table_name: "income_service_charge" },
                            { acct_id: "3", acct_code: "403", acct_desc: "Electricity Bills", acct_table_name: "income_electricity_bills" },
                            { acct_id: "4", acct_code: "404", acct_desc: "Parking Fees", acct_table_name: "income_parking_fees" }
                        ];
                        
                        sampleAccounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account.acct_code;
                            option.textContent = `${account.acct_desc} (${account.acct_code})`;
                            option.dataset.tableId = account.acct_table_name;
                            incomeLineSelect.appendChild(option);
                        });
                    });
            }
            
            // Generate income summary
            function generateIncomeSummary() {
                const selectedAccountCode = incomeLineSelect.value;
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (!selectedAccountCode || !startDate || !endDate) {
                    alert('Please select an income line and date range');
                    return;
                }
                
                // Update button state to show loading
                generateSummaryBtn.textContent = 'Loading...';
                generateSummaryBtn.disabled = true;
                
                // Get selected account display name
                const selectedAccountText = incomeLineSelect.options[incomeLineSelect.selectedIndex].text;
                
                // Format dates for display
                const formatDate = function(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };
                
                // Fetch data via AJAX
                fetch(`api/income-summary.php?account=${selectedAccountCode}&start_date=${startDate}&end_date=${endDate}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update UI with data
                        summaryTitle.textContent = `Summary for ${data.account.description}`;
                        summaryDateRange.textContent = `From ${formatDate(startDate)} to ${formatDate(endDate)}`;
                        
                        // Format currency
                        const formattedTotal = new Intl.NumberFormat('en-NG', {
                            style: 'currency',
                            currency: 'NGN',
                            minimumFractionDigits: 2
                        }).format(data.total_amount);
                        
                        totalIncomeDisplay.textContent = `Total Income: ${formattedTotal}`;
                        
                        // Update transaction count
                        transactionCount.textContent = `Showing ${data.transactions.length} transactions`;
                        
                        // Populate transactions table
                        transactionsTable.innerHTML = '';
                        data.transactions.forEach(transaction => {
                            const formattedAmount = new Intl.NumberFormat('en-NG', {
                                style: 'currency',
                                currency: 'NGN',
                                minimumFractionDigits: 2
                            }).format(transaction.amount);
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${transaction.transaction_date}</td>
                                <td>${transaction.description}</td>
                                <td>${transaction.receipt_no || '-'}</td>
                                <td class="text-right">${formattedAmount}</td>
                            `;
                            transactionsTable.appendChild(row);
                        });
                        
                        // Show results section
                        summaryResults.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error fetching income summary:', error);
                        
                        // Generate mock data for demo/preview purposes
                        const mockTransactions = [];
                        const totalAmount = Math.floor(Math.random() * 10000000) + 500000;
                        
                        // Generate random transactions
                        const startDateObj = new Date(startDate);
                        const endDateObj = new Date(endDate);
                        let currentDate = new Date(startDateObj);
                        
                        while (currentDate <= endDateObj) {
                            if (Math.random() > 0.4) { // Not every day has transactions
                                const amount = Math.floor(Math.random() * 100000) + 5000;
                                
                                mockTransactions.push({
                                    transaction_date: currentDate.toISOString().split('T')[0],
                                    description: `Payment for ${selectedAccountText}`,
                                    receipt_no: `REC-${Math.floor(Math.random() * 10000)}`,
                                    amount: amount
                                });
                            }
                            
                            // Move to next day
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        
                        // Update UI with mock data
                        summaryTitle.textContent = `Summary for ${selectedAccountText}`;
                        summaryDateRange.textContent = `From ${formatDate(startDate)} to ${formatDate(endDate)}`;
                        
                        const formattedTotal = new Intl.NumberFormat('en-NG', {
                            style: 'currency',
                            currency: 'NGN',
                            minimumFractionDigits: 2
                        }).format(totalAmount);
                        
                        totalIncomeDisplay.textContent = `Total Income: ${formattedTotal}`;
                        transactionCount.textContent = `Showing ${mockTransactions.length} transactions`;
                        
                        // Populate transactions table with mock data
                        transactionsTable.innerHTML = '';
                        mockTransactions.forEach(transaction => {
                            const formattedAmount = new Intl.NumberFormat('en-NG', {
                                style: 'currency',
                                currency: 'NGN',
                                minimumFractionDigits: 2
                            }).format(transaction.amount);
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${transaction.transaction_date}</td>
                                <td>${transaction.description}</td>
                                <td>${transaction.receipt_no || '-'}</td>
                                <td class="text-right">${formattedAmount}</td>
                            `;
                            transactionsTable.appendChild(row);
                        });
                        
                        // Show results section
                        summaryResults.style.display = 'block';
                    })
                    .finally(() => {
                        // Reset button state
                        generateSummaryBtn.textContent = 'Generate Summary';
                        generateSummaryBtn.disabled = false;
                    });
            }
        });
    </script>
</body>
</html>
